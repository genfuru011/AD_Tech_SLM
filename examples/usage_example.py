#!/usr/bin/env python3
"""
TinySwallow DPO Training - Usage Example
Google Colabç’°å¢ƒã§ã®ä½¿ç”¨æ–¹æ³•ã‚’ç¤ºã™ã‚µãƒ³ãƒ—ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import json
from typing import Dict, List

def create_sample_dataset() -> List[Dict[str, str]]:
    """åºƒå‘ŠæŠ€è¡“åˆ†é‡ã®ã‚µãƒ³ãƒ—ãƒ«DPOãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆ"""
    return [
        {
            "prompt": "ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯åºƒå‘Šã®RTBã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
            "chosen": "RTBï¼ˆReal-Time Biddingï¼‰ã¯ã€åºƒå‘Šæ ã®å£²è²·ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³å½¢å¼ã§è¡Œã†ä»•çµ„ã¿ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒWebãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸç¬é–“ã«ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±æ€§ã‚„é–²è¦§å±¥æ­´ã«åŸºã¥ã„ã¦ã€åºƒå‘Šä¸»ãŒè‡ªå‹•çš„ã«å…¥æœ­ã‚’è¡Œã„ã¾ã™ã€‚æœ€ã‚‚é«˜ã„é‡‘é¡ã‚’æç¤ºã—ãŸåºƒå‘Šä¸»ã®åºƒå‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ä»•çµ„ã¿ã§ã€åŠ¹ç‡çš„ãªã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ã¨è²»ç”¨å¯¾åŠ¹æœã®å‘ä¸Šã‚’å®Ÿç¾ã—ã¾ã™ã€‚",
            "rejected": "RTBã¯åºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚"
        },
        {
            "prompt": "DSPã¨SSPã®é•ã„ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚",
            "chosen": "DSPï¼ˆDemand-Side Platformï¼‰ã¯åºƒå‘Šä¸»å´ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã€åºƒå‘Šæ ã®è³¼å…¥ã‚’è‡ªå‹•åŒ–ã—ã€ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ã‚„å…¥æœ­æˆ¦ç•¥ã®æœ€é©åŒ–ã‚’è¡Œã„ã¾ã™ã€‚ä¸€æ–¹ã€SSPï¼ˆSupply-Side Platformï¼‰ã¯ãƒ¡ãƒ‡ã‚£ã‚¢å´ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã€åºƒå‘Šæ ã®è²©å£²ã‚’è‡ªå‹•åŒ–ã—ã€åç›Šã®æœ€å¤§åŒ–ã‚’å›³ã‚Šã¾ã™ã€‚DSPã¯è²·ã„æ‰‹ã€SSPã¯å£²ã‚Šæ‰‹ã®ç«‹å ´ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯åºƒå‘Šã®å–å¼•ã‚’æ”¯æ´ã—ã¾ã™ã€‚",
            "rejected": "DSPã¨SSPã¯ä¸¡æ–¹ã¨ã‚‚åºƒå‘Šé–¢é€£ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚"
        },
        {
            "prompt": "ã‚¯ãƒƒã‚­ãƒ¼ãƒ¬ã‚¹æ™‚ä»£ã®åºƒå‘Šã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°æ‰‹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚",
            "chosen": "ã‚¯ãƒƒã‚­ãƒ¼ãƒ¬ã‚¹æ™‚ä»£ã§ã¯ã€ä»¥ä¸‹ã®æ‰‹æ³•ãŒé‡è¦ã¨ãªã‚Šã¾ã™ï¼š1) ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ‘ãƒ¼ãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ã®æ´»ç”¨ï¼ˆè‡ªç¤¾ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã€2) ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåºƒå‘Šï¼ˆWebãƒšãƒ¼ã‚¸ã®å†…å®¹ã«åŸºã¥ã„ãŸã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ï¼‰ã€3) ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æï¼ˆé¡ä¼¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã§ã®åˆ†æï¼‰ã€4) ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹æŠ€è¡“ï¼ˆGoogleãŒææ¡ˆã™ã‚‹æ–°æŠ€è¡“ç¾¤ï¼‰ã€5) IDã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ™ãƒ¼ã‚¹ã®è­˜åˆ¥å­ï¼‰ãªã©ãŒã‚ã‚Šã¾ã™ã€‚",
            "rejected": "ã‚¯ãƒƒã‚­ãƒ¼ãŒä½¿ãˆãªããªã‚‹ã®ã§ã€æ–°ã—ã„æ–¹æ³•ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
        },
        {
            "prompt": "ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æã®é‡è¦æ€§ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚",
            "chosen": "ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æã¯ã€ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«è‡³ã‚‹ã¾ã§ã®å„ã‚¿ãƒƒãƒãƒã‚¤ãƒ³ãƒˆã®è²¢çŒ®åº¦ã‚’æ¸¬å®šã™ã‚‹åˆ†ææ‰‹æ³•ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³¼è²·è¡Œå‹•ã¯è¤‡é›‘ã§ã€è¤‡æ•°ã®åºƒå‘Šæ¥è§¦ã‚’çµŒã¦ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«è‡³ã‚‹ãŸã‚ã€ãƒ©ã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯ä»¥å¤–ã®æ¥è§¦ç‚¹ã®ä¾¡å€¤ã‚‚é©åˆ‡ã«è©•ä¾¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°äºˆç®—ã®æœ€é©é…åˆ†ã€ãƒãƒ£ãƒãƒ«é–“ã®ç›¸äº’ä½œç”¨ã®ç†è§£ã€ROIã®æ­£ç¢ºãªæ¸¬å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚",
            "rejected": "ã‚¢ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æã¯åºƒå‘Šã®åŠ¹æœã‚’æ¸¬å®šã™ã‚‹æ–¹æ³•ã§ã™ã€‚"
        },
        {
            "prompt": "ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ“ãƒ‡ã‚£ãƒ³ã‚°ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
            "chosen": "ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ“ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆHeader Biddingï¼‰ã¯ã€è¤‡æ•°ã®SSPã‚„ã‚¢ãƒ‰ã‚¨ã‚¯ã‚¹ãƒã‚§ãƒ³ã‚¸ãŒåŒæ™‚ã«åºƒå‘Šæ ã«å…¥æœ­ã§ãã‚‹ä»•çµ„ã¿ã§ã™ã€‚å¾“æ¥ã®ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ«æ–¹å¼ã¨ã¯ç•°ãªã‚Šã€ã™ã¹ã¦ã®éœ€è¦æºãŒåŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç«¶åˆã§ãã‚‹ãŸã‚ã€ã‚ˆã‚Šå…¬å¹³ã§é€æ˜æ€§ã®é«˜ã„ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿç¾ã•ã‚Œã¾ã™ã€‚çµæœã¨ã—ã¦ã€ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã®åç›Šå‘ä¸Šã¨åºƒå‘Šä¸»ã®åŠ¹ç‡çš„ãªé…ä¿¡ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚",
            "rejected": "ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ“ãƒ‡ã‚£ãƒ³ã‚°ã¯åºƒå‘Šæ ã‚’å£²ã‚‹æ–¹æ³•ã®ä¸€ã¤ã§ã™ã€‚"
        }
    ]

def get_optimal_config_for_colab() -> Dict:
    """Google Colabç’°å¢ƒã«æœ€é©åŒ–ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®šã‚’è¿”ã™"""
    return {
        # ãƒ¢ãƒ‡ãƒ«è¨­å®š
        "model_name": "SakanaAI/TinySwallow-1.5B-Instruct",
        "backup_models": [
            "tokyotech-llm/Swallow-1.5b-instruct-hf",
            "rinna/japanese-gpt-neox-3.6b-instruction-sft"
        ],
        
        # Colabæœ€é©åŒ–è¨­å®š
        "per_device_train_batch_size": 1,  # ãƒ¡ãƒ¢ãƒªåˆ¶é™å¯¾å¿œ
        "gradient_accumulation_steps": 8,   # å®Ÿè³ªãƒãƒƒãƒã‚µã‚¤ã‚º = 8
        "learning_rate": 5e-7,              # å®‰å®šã—ãŸå­¦ç¿’
        "max_steps": 500,                   # Colabæ™‚é–“åˆ¶é™å¯¾å¿œ
        "eval_steps": 50,
        "save_steps": 100,
        "warmup_steps": 50,
        
        # DPOè¨­å®š
        "beta": 0.1,
        "max_length": 1024,
        "max_prompt_length": 512,
        
        # LoRAè¨­å®šï¼ˆãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–ï¼‰
        "lora_r": 16,
        "lora_alpha": 32,
        "lora_dropout": 0.05,
        "target_modules": ["q_proj", "v_proj", "k_proj", "o_proj"],
        
        # é‡å­åŒ–è¨­å®š
        "use_4bit": True,
        "bnb_4bit_compute_dtype": "float16",
        "bnb_4bit_quant_type": "nf4",
        "use_nested_quant": False,
    }

def save_dataset_to_jsonl(dataset: List[Dict], filename: str = "sample_dpo_dataset.jsonl"):
    """ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’JSONLå½¢å¼ã§ä¿å­˜"""
    with open(filename, 'w', encoding='utf-8') as f:
        for item in dataset:
            f.write(json.dumps(item, ensure_ascii=False) + '\n')
    print(f"âœ… ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¿å­˜: {filename} ({len(dataset)} ã‚µãƒ³ãƒ—ãƒ«)")

def validate_dpo_dataset(dataset: List[Dict]) -> bool:
    """DPOãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å½¢å¼ã‚’æ¤œè¨¼"""
    required_keys = ['prompt', 'chosen', 'rejected']
    
    for i, item in enumerate(dataset):
        if not all(key in item for key in required_keys):
            print(f"âŒ ã‚µãƒ³ãƒ—ãƒ« {i}: å¿…è¦ãªã‚­ãƒ¼ {required_keys} ãŒä¸è¶³")
            return False
        
        if not all(isinstance(item[key], str) for key in required_keys):
            print(f"âŒ ã‚µãƒ³ãƒ—ãƒ« {i}: ã™ã¹ã¦ã®å€¤ã¯æ–‡å­—åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")
            return False
    
    print(f"âœ… ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ¤œè¨¼å®Œäº†: {len(dataset)} ã‚µãƒ³ãƒ—ãƒ«")
    return True

def print_training_tips():
    """ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º"""
    print("ğŸ¯ TinySwallow DPO Training - ä½¿ç”¨ã®ãƒ’ãƒ³ãƒˆ")
    print("=" * 50)
    print("1. ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæº–å‚™:")
    print("   â€¢ JSONLå½¢å¼ã§prompt, chosen, rejectedã‚­ãƒ¼ã‚’å«ã‚€")
    print("   â€¢ è³ªã®é«˜ã„chosenå›ç­”ã¨æ˜ç¢ºã«åŠ£ã‚‹rejectedå›ç­”ã®ãƒšã‚¢")
    print("   â€¢ æœ€ä½100ã‚µãƒ³ãƒ—ãƒ«ã€æ¨å¥¨1000+ã‚µãƒ³ãƒ—ãƒ«")
    print()
    print("2. âš™ï¸ è¨­å®šã®èª¿æ•´:")
    print("   â€¢ ãƒ¡ãƒ¢ãƒªä¸è¶³æ™‚: batch_sizeã‚’1ã«ã€gradient_accumulation_stepsã‚’å¢—åŠ ")
    print("   â€¢ å­¦ç¿’ãŒä¸å®‰å®š: learning_rateã‚’ä¸‹ã’ã‚‹ (1e-7 ~ 5e-7)")
    print("   â€¢ éå­¦ç¿’ã®å…†å€™: max_stepsã‚’æ¸›ã‚‰ã™ã‹eval_stepsã‚’é »ç¹ã«")
    print()
    print("3. ğŸš€ å®Ÿè¡Œç’°å¢ƒ:")
    print("   â€¢ GPUå¿…é ˆ (T4ä»¥ä¸Šæ¨å¥¨)")
    print("   â€¢ å®Ÿè¡Œæ™‚é–“: 500ã‚¹ãƒ†ãƒƒãƒ—ã§ç´„30-60åˆ†")
    print("   â€¢ Colab Proæ¨å¥¨ (ã‚ˆã‚Šé«˜æ€§èƒ½ãªGPUã¨é•·æ™‚é–“å®Ÿè¡Œ)")
    print()
    print("4. ğŸ“ˆ è©•ä¾¡ã®ãƒã‚¤ãƒ³ãƒˆ:")
    print("   â€¢ è¨“ç·´ãƒ­ã‚¹ã®å®‰å®šã—ãŸæ¸›å°‘")
    print("   â€¢ æ¤œè¨¼ãƒ­ã‚¹ã®éå­¦ç¿’ãƒã‚§ãƒƒã‚¯")
    print("   â€¢ ç”Ÿæˆãƒ†ã‚­ã‚¹ãƒˆã®å“è³ªå‘ä¸Š")

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    print("ğŸ¦† TinySwallow DPO Training - Usage Example")
    print("=" * 50)
    
    # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ä½œæˆ
    dataset = create_sample_dataset()
    
    # ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ¤œè¨¼
    if validate_dpo_dataset(dataset):
        # JSONLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
        save_dataset_to_jsonl(dataset)
        
        # æœ€é©åŒ–è¨­å®šã®è¡¨ç¤º
        config = get_optimal_config_for_colab()
        print(f"\nâš™ï¸ æ¨å¥¨è¨­å®š:")
        for key, value in config.items():
            print(f"   {key}: {value}")
        
        # ä½¿ç”¨ã®ãƒ’ãƒ³ãƒˆè¡¨ç¤º
        print()
        print_training_tips()
        
        print("\nğŸ”— æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
        print("   1. Google Colabã§ improved notebook ã‚’é–‹ã")
        print("   2. ä½œæˆã•ã‚ŒãŸsample_dpo_dataset.jsonlã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
        print("   3. è¨­å®šã‚’ç¢ºèªã—ã¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹")
        print("   4. çµæœã‚’è©•ä¾¡ã—ã¦å¿…è¦ã«å¿œã˜ã¦èª¿æ•´")

if __name__ == "__main__":
    main()